<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Grand Sale</title>
 <style>
 body {
 font-family: 'Segoe UI', Arial, sans-serif;
 margin: 0;
 padding: 0;
 background-color: #f0f2f5;
 color: #333;
 height: 100%;
 }
 .container {
 width: 90%;
 max-width: 1000px;
 margin: 20px auto;
 padding: 20px;
 background-color: #fff;
 border-radius: 10px;
 box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
 }
 header {
 text-align: center;
 padding-bottom: 20px;
 border-bottom: 1px solid #e0e0e0;
 background-color: #2a9d8f; /* Teal */
 }
 header h1 {
 margin: 0;
 font-size: 2em;
 color: #1a3c34; /* Dark Teal */
 }
 nav {
 margin: 20px 0;
 display: flex;
 flex-wrap: wrap;
 justify-content: center;
 gap: 10px;
 }
 nav button {
 padding: 12px 24px;
 border: none;
 background-color: #e9c46a; /* Yellow */
 color: #1a3c34; /* Dark Teal */
 border-radius: 8px;
 cursor: pointer;
 font-size: 1em;
 transition: background-color 0.3s, transform 0.2s;
 min-width: 120px;
 }
 nav button:hover {
 background-color: #f4a261; /* Orange */
 transform: scale(1.05);
 }
 .section {
 display: none;
 padding: 20px;
 background-color: #e9c46a80; /* Yellow with 50% opacity */
 border-radius: 8px;
 margin-bottom: 20px;
 }
 .section.active {
 display: block;
 }
 .wallet-status {
 text-align: center;
 margin: 20px 0;
 padding: 15px;
 background-color: #f9f9f9;
 border-radius: 8px;
 box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
 display: flex;
 flex-wrap: wrap;
 justify-content: center;
 gap: 10px;
 }
 .wallet-status button, .control-btn {
 padding: 10px 20px;
 border: none;
 background-color: #2a9d8f; /* Teal */
 color: #fff;
 border-radius: 6px;
 cursor: pointer;
 transition: background-color 0.3s;
 min-width: 140px;
 }
 .wallet-status button:hover, .control-btn:hover {
 background-color: #1a3c34; /* Dark Teal */
 }
 .wallet-connected {
 color: #2a9d8f; /* Teal */
 font-weight: bold;
 margin: 10px 0;
 cursor: pointer;
 }
 .wallet-instructions {
 margin-top: 15px;
 padding: 10px;
 background-color: #fff3cd;
 color: #856404;
 border-radius: 6px;
 border: 1px solid #ffeeba;
 width: 100%;
 }
 .history {
 margin-top: 20px;
 display: none;
 }
 .history h3 {
 background-color: #2a9d8f; /* Teal */
 color: #fff;
 padding: 10px;
 margin: 0;
 border-radius: 6px 6px 0 0;
 text-align: center;
 }
 .log-content {
 padding: 10px;
 background-color: #f9f9f9;
 border: 1px solid #ddd;
 border-radius: 0 0 6px 6px;
 max-height: 300px;
 overflow-y: auto;
 }
 .log-table {
 width: 100%;
 border-collapse: collapse;
 table-layout: fixed;
 }
 .log-table th, .log-table td {
 padding: 8px;
 border: 1px solid #ddd;
 text-align: left;
 word-wrap: break-word;
 }
 .log-table th:nth-child(1), .log-table td:nth-child(1) { width: 20%; }
 .log-table th:nth-child(2), .log-table td:nth-child(2) { width: 20%; }
 .log-table th:nth-child(3), .log-table td:nth-child(3) { 
 width: 60%; 
 word-break: break-all;
 }
 .event-success { color: #2a9d8f; /* Teal */ }
 .event-error { color: #dc3545; }
 .contract-info-table, .payment-tokens-table {
 width: 100%;
 border-collapse: collapse;
 margin-top: 20px;
 background-color: #fff;
 border-radius: 8px;
 box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
 }
 .contract-info-table th, .contract-info-table td,
 .payment-tokens-table th, .payment-tokens-table td {
 padding: 12px;
 border: 1px solid #e0e0e0;
 text-align: left;
 }
 .contract-info-table th {
 background-color: #2a9d8f; /* Teal */
 color: #fff;
 }
 .payment-tokens-table th {
 background-color: #e76f51; /* Coral */
 color: #fff;
 }
 .contract-info-table td, .payment-tokens-table td {
 position: relative;
 }
 .copy-btn {
 position: absolute;
 right: 10px;
 top: 50%;
 transform: translateY(-50%);
 padding: 4px 8px;
 background-color: #f4a261; /* Orange */
 color: #fff;
 border: none;
 border-radius: 4px;
 cursor: pointer;
 }
 .payment-tokens-table th:nth-child(1), .payment-tokens-table td:nth-child(1) { width: 40%; }
 .payment-tokens-table th:nth-child(2), .payment-tokens-table td:nth-child(2) { width: 20%; }
 .payment-tokens-table th:nth-child(3), .payment-tokens-table td:nth-child(3) { width: 15%; }
 .payment-tokens-table th:nth-child(4), .payment-tokens-table td:nth-child(4) { width: 25%; }
 .error {
 color: #dc3545;
 margin-top: 10px;
 word-wrap: break-word;
 }
 #token-receive-info {
 margin-top: 10px;
 font-weight: bold;
 color: #1a3c34; /* Dark Teal */
 }
 select, input[type="text"], input[type="number"] {
 width: 100%;
 max-width: 280px;
 height: 40px;
 padding: 8px;
 margin: 8px 0;
 border: 1px solid #2a9d8f; /* Teal */
 border-radius: 6px;
 font-size: 1em;
 box-sizing: border-box;
 }
 .input-group {
 position: relative;
 display: flex;
 align-items: center;
 gap: 10px;
 flex-wrap: wrap;
 }
 .max-btn {
 padding: 6px 12px;
 background-color: #f4a261; /* Orange */
 color: #fff;
 border: none;
 border-radius: 4px;
 cursor: pointer;
 font-size: 0.9em;
 }
 .balance-display {
 margin: 8px 0;
 font-size: 0.9em;
 color: #1a3c34; /* Dark Teal */
 cursor: pointer;
 }
 .balance-display:hover {
 text-decoration: underline;
 }
 .control-group {
 display: flex;
 flex-direction: column;
 gap: 10px;
 margin: 15px 0;
 padding: 15px;
 background-color: #f9f9f9;
 border-radius: 8px;
 }
 #approve-section {
 display: none;
 }
 #approve-section.active {
 display: flex;
 }
 .control-row {
 display: flex;
 flex-wrap: wrap;
 gap: 10px;
 align-items: center;
 }
 @media (max-width: 600px) {
 nav button { width: 100%; max-width: 200px; margin: 5px auto; }
 .wallet-status button, .control-btn { width: 100%; max-width: 200px; }
 .control-row { flex-direction: column; align-items: stretch; }
 select, input[type="text"], input[type="number"] { max-width: 100%; }
 .container { padding: 10px; }
 }
 </style>
</head>
<body>
 <div class="container">
 <header>
 <h1>Grand Sale</h1>
 <div class="wallet-status" id="wallet-status">
 <button id="switch-account-btn" class="control-btn" style="display: none;">Change Wallet</button>
 <button id="connect-wallet-btn" class="control-btn">Connect Wallet</button>
 <button id="add-amoy-btn" class="control-btn">Add Amoy Network</button>
 <button id="add-sale-token-btn" class="control-btn" style="display: none;">Add Sale Token</button>
 <button id="add-payment-token-btn" class="control-btn" style="display: none;">Add Payment Token</button>
 <select id="payment-token-to-metamask" style="display: none;">
 <option value="">Select Payment Token</option>
 </select>
 <button id="refresh-btn" class="control-btn">Refresh</button>
 <div id="wallet-info" style="display: none; width: 100%;">
 <p id="connected-address" class="wallet-connected"></p>
 <p id="connected-network"></p>
 <button id="disconnect-wallet-btn" class="control-btn">Disconnect</button>
 </div>
 <div id="wallet-instructions" class="wallet-instructions" style="display: none;"></div>
 </div>
 </header>
 <nav id="navigation">
 <button id="home-btn" onclick="showSection('home')" style="display: none;">Home</button>
 <button id="admin-btn" onclick="showSection('owner')" style="display: none;">Admin</button>
 </nav>
 <div id="home" class="section active">
 <h2>Grand Sale</h2>
 <table class="contract-info-table">
 <thead>
 <tr>
 <th>Detail</th>
 <th>Value</th>
 </tr>
 </thead>
 <tbody>
 <tr><td>Contract Address</td><td id="contract-address">Connect First<button class="copy-btn" onclick="copyToClipboard('contract-address')">Copy</button></td></tr>
 <tr><td>Sale Token</td><td id="sale-token">Connect First<button class="copy-btn" onclick="copyToClipboard('sale-token')">Copy</button></td></tr>
 <tr><td>Total Unsold</td><td id="total-unsold">Connect First</td></tr>
 <tr><td>Minimum Buy to Reward</td><td id="min-buy-to-reward">Connect First</td></tr>
 <tr><td>Total Sold</td><td id="total-sold">Connect First</td></tr>
 <tr><td>Total Rewarded</td><td id="total-rewarded">Connect First</td></tr>
 </tbody>
 </table>
 <div>
 <h3>Accepted Payment Tokens</h3>
 <table class="payment-tokens-table" id="payment-tokens-table">
 <thead>
 <tr>
 <th>Token</th>
 <th>Rate</th>
 <th>Reward (%)</th>
 <th>Total Raised</th>
 </tr>
 </thead>
 <tbody id="payment-tokens-body"></tbody>
 </table>
 </div>
 <div class="control-group">
 <h3>Your Balance</h3>
 <p>Sale Token Balance: <span id="user-sale-balance">0</span></p>
 </div>

 <div class="control-group">
 <h3>Buy Tokens</h3>
 <div class="control-row">
 <select id="payment-token-select" onchange="updateBuyBalance()">
 <option value="">Select Payment Token</option>
 </select>
 <span id="buy-balance" class="balance-display" onclick="setMaxBuy()">0</span>
 </div>
 <div class="control-row">
 <div class="input-group">
 <input type="number" id="payment-amount" placeholder="Amount" step="0.01" oninput="updateTokenReceiveInfo()">
 <button class="max-btn" onclick="setMaxBuy()">Max</button>
 </div>
 <button id="buy-btn" class="control-btn" onclick="buyTokens()">Buy</button>
 </div>
 <p id="token-receive-info"></p>
 </div>

 <div class="control-group" id="approve-section">
 <h3>Increase Token Allowance</h3>
 <div class="control-row">
 <select id="approve-token-select" onchange="updateApproveBalance()">
 <option value="">Select Payment Token</option>
 </select>
 <span id="approve-balance" class="balance-display">0</span>
 </div>
 <div class="control-row">
 <button id="approve-btn" class="control-btn" onclick="approveToken()">Approve</button>
 </div>
 </div>
 
 <div class="control-group">
 <h3>Send Sale Tokens</h3>
 <div class="control-row">
 <input type="text" id="send-recipient" placeholder="Recipient Address">
 <span id="send-balance" class="balance-display" onclick="setMaxSend()">0</span>
 </div>
 <div class="control-row">
 <div class="input-group">
 <input type="number" id="send-amount" placeholder="Amount to Send" step="0.01">
 <button class="max-btn" onclick="setMaxSend()">Max</button>
 </div>
 <button id="send-btn" class="control-btn" onclick="sendTokens()">Send Tokens</button>
 </div>
 </div>
 <div id="tx-status"></div>
 <div id="error-message" class="error"></div>
 </div>
 <div id="owner" class="section">
 <h2>Admin</h2>
 <div class="control-group">
 <h3>Manage Payment Tokens</h3>
 <div class="control-row">
 <input type="text" id="payment-token-address" placeholder="Payment Token Address">
 <button id="add-payment-btn" class="control-btn" onclick="addPaymentToken()">Add Payment Token</button>
 </div>
 <div class="control-row">
 <select id="remove-payment-token-select">
 <option value="">Select Payment Token to Remove</option>
 </select>
 <button id="remove-payment-btn" class="control-btn" onclick="removePaymentToken()">Remove Payment Token</button>
 </div>
 </div>
 <div class="control-group">
 <h3>Set Rate</h3>
 <div class="control-row">
 <select id="rate-token">
 <option value="">Select Payment Token</option>
 </select>
 <input type="number" id="rate-value" placeholder="Rate" step="1">
 </div>
 <div class="control-row">
 <button id="set-rate-btn" class="control-btn" onclick="setRate()">Set Rate</button>
 <button id="remove-rate-btn" class="control-btn" onclick="removeRate()">Remove Rate</button>
 </div>
 </div>
 <div class="control-group">
 <h3>Set Reward</h3>
 <div class="control-row">
 <select id="reward-token">
 <option value="">Select Payment Token</option>
 </select>
 <input type="number" id="reward-value" placeholder="Reward Percentage (1-100)" step="1">
 </div>
 <div class="control-row">
 <button id="set-reward-btn" class="control-btn" onclick="setReward()">Set Reward</button>
 <button id="remove-reward-btn" class="control-btn" onclick="removeReward()">Remove Reward</button>
 </div>
 </div>
 <div class="control-group">
 <h3>Set Minimum Buy to Reward</h3>
 <div class="control-row">
 <input type="number" id="min-buy-value" placeholder="Minimum Buy Amount" step="1">
 <button id="set-min-buy-btn" class="control-btn" onclick="setMinBuyToReward()">Set Min Buy</button>
 </div>
 <div class="control-row">
 <button id="remove-min-buy-btn" class="control-btn" onclick="removeMinBuyToReward()">Remove Min Buy</button>
 </div>
 </div>
 <div class="control-group">
 <h3>Contract Status</h3>
 <p>Status: <span id="contract-status">Unknown</span></p>
 <button id="toggle-pause-btn" class="control-btn" onclick="togglePause()">Toggle Pause</button>
 </div>
 <div class="control-group">
 <h3>Withdraw</h3>
 <div class="control-row">
 <select id="withdraw-token">
 <option value="">Select Token to Withdraw</option>
 </select>
 <input type="number" id="withdraw-amount" placeholder="Amount" step="0.01">
 </div>
 <div class="control-row">
 <button id="withdraw-btn" class="control-btn" onclick="withdraw()">Withdraw</button>
 </div>
 </div>
 <div id="tx-status"></div>
 <div id="error-message" class="error"></div>
 </div>
 <div id="history" class="history">
 <h3>History</h3>
 <div class="log-content">
 <table class="log-table">
 <thead>
 <tr>
 <th>Time</th>
 <th>Event</th>
 <th>Details</th>
 </tr>
 </thead>
 <tbody id="log-body"></tbody>
 </table>
 </div>
 </div>
 </div>
 <script src="https://unpkg.com/web3@1.10.4/dist/web3.min.js"></script>
 <script>
  const CONTRACT_ADDRESS = "0x65ed5aa09d34959214bdbb8b634e486081447e36";
  const GrandSaleABI = [{"inputs":[{"internalType":"address","name":"_token","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"approver","type":"address"},{"indexed":false,"internalType":"address","name":"paymentToken","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Approved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"paymentAmount","type":"uint256"}],"name":"FundsSecured","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"minBuyToReward","type":"uint256"}],"name":"MinBuyToRewardRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"minBuyToReward","type":"uint256"}],"name":"MinBuyToRewardSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokenAmount","type":"uint256"}],"name":"NotEligible","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"paymentToken","type":"address"}],"name":"PaymentTokenAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"paymentToken","type":"address"}],"name":"PaymentTokenRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"rate","type":"uint256"},{"indexed":false,"internalType":"address","name":"paymentToken","type":"address"}],"name":"RateSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"paymentToken","type":"address"}],"name":"RateRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":true,"internalType":"address","name":"paymentToken","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokenAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardAmount","type":"uint256"}],"name":"RewardGranted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"paymentToken","type":"address"},{"indexed":false,"internalType":"uint256","name":"reward","type":"uint256"}],"name":"RewardSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"paymentToken","type":"address"}],"name":"RewardRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokenAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"paymentAmount","type":"uint256"}],"name":"TokenPurchased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"token","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"address","name":"owner","type":"address"}],"name":"Withdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[{"internalType":"address","name":"paymentToken","type":"address"}],"name":"addPaymentToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"paymentToken","type":"address"},{"internalType":"uint256","name":"paymentAmount","type":"uint256"}],"name":"buyWithToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"buyWithNative","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"minBuyToReward","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"paymentToken","type":"address"}],"name":"paymentTokens","outputs":[{"internalType":"bool","name":"isAccepted","type":"bool"},{"internalType":"uint256","name":"rate","type":"uint256"},{"internalType":"uint256","name":"reward","type":"uint256"},{"internalType":"uint256","name":"totalRaised","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"removeMinBuyToReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"paymentToken","type":"address"}],"name":"removePaymentToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"paymentToken","type":"address"}],"name":"removeRate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"paymentToken","type":"address"}],"name":"removeReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"saleToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_minBuyToReward","type":"uint256"}],"name":"setMinBuyToReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"paymentToken","type":"address"},{"internalType":"uint256","name":"rate","type":"uint256"}],"name":"setRate","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"paymentToken","type":"address"},{"internalType":"uint256","name":"reward","type":"uint256"}],"name":"setReward","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"token","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalRewarded","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSold","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_tokenAddress","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"stateMutability":"payable","type":"receive"}]
;
  const ERC20ABI = [{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"decimals","outputs":[{"name":"","type":"uint8"}],"type":"function"},{"constant":true,"inputs":[],"name":"symbol","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":true,"inputs":[],"name":"name","outputs":[{"name":"","type":"string"}],"type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"","type":"uint256"}],"type":"function"}];

  let web3, contract, userAddress, saleTokenAddress, ownerAddress, saleTokenSymbol = "Token";
  let tokenInfoMap = new Map();
  const NATIVE_TOKEN_ADDRESS = "0x0000000000000000000000000000000000000000";
  const AMOY_CHAIN_ID = '0x13882'; // Polygon Amoy Testnet

  // Initialize Web3 on page load
  async function initializeWeb3() {
    if (typeof window.ethereum !== 'undefined') {
      web3 = new Web3(window.ethereum);
      try {
        const accounts = await web3.eth.getAccounts();
        if (accounts.length > 0) {
          userAddress = accounts[0];
          await initializeAfterConnect();
        }
        window.ethereum.on('accountsChanged', handleAccountsChanged);
        window.ethereum.on('chainChanged', handleChainChanged);
      } catch (error) {
        console.error('Error checking initial connection:', error);
      }
    } else {
      showError('home', "Please install MetaMask!");
      showWalletInstructions();
    }
  }

  // Handle chain changes
  async function handleChainChanged(chainId) {
    console.log("Chain changed to:", chainId);
    const networkName = chainId === AMOY_CHAIN_ID ? 'Polygon Amoy' : 'Unknown Network';
    document.getElementById('connected-network').innerHTML = `Connected Network: ${networkName}`;
    if (chainId !== AMOY_CHAIN_ID) {
      showError('home', "Please switch to Polygon Amoy network.");
      await switchToAmoy();
    } else {
      await updateContractInfo();
      await updateUserBalance();
      await updateAllDropdowns();
    }
  }

  // Log Event with FundsSecured filtering
  function logEvent(eventName, details, isSuccess = true, isAdminEvent = false, txHash = null, timestamp = null) {
    const isOwner = userAddress && userAddress.toLowerCase() === ownerAddress?.toLowerCase();
    // Hide FundsSecured from non-owners
    if (eventName === 'FundsSecured' && !isOwner) return;
    if (!isOwner && isAdminEvent) return;
    const logBody = document.getElementById('log-body');
    const row = document.createElement('tr');
    row.className = isSuccess ? 'event-success' : 'event-error';
    const detailsCell = txHash 
      ? `<a href="https://amoy.polygonscan.com/tx/${txHash}" target="_blank">${details}</a>`
      : details;
    const time = timestamp || (txHash ? 'Pending...' : new Date().toLocaleString());
    row.innerHTML = `<td>${time}</td><td>${eventName}</td><td>${detailsCell}</td>`;
    logBody.insertBefore(row, logBody.firstChild);
    if (txHash && !timestamp) {
      getTransactionTimestamp(txHash).then(ts => {
        row.cells[0].textContent = ts;
      });
    }
  }

  // Fetch and log historical events with FundsSecured filtering
  async function fetchAndLogHistoricalEvents() {
    try {
      const events = await contract.getPastEvents('allEvents', { fromBlock: 0, toBlock: 'latest' });
      const isOwner = userAddress.toLowerCase() === ownerAddress.toLowerCase();
      for (const event of events) {
        const isAdminEvent = [
          'PaymentTokenAdded', 'PaymentTokenRemoved', 'RateSet', 'RateRemoved',
          'RewardSet', 'RewardRemoved', 'MinBuyToRewardSet', 'MinBuyToRewardRemoved',
          'Withdrawn', 'Paused', 'Unpaused'
        ].includes(event.event);
        // Skip FundsSecured for non-owners
        if (event.event === 'FundsSecured' && !isOwner) continue;
        if (!isOwner && isAdminEvent) continue;
        const txHash = event.transactionHash;
        const details = formatEventDetails(event);
        const timestamp = await getTransactionTimestamp(txHash);
        logEvent(event.event, details, true, isAdminEvent, txHash, timestamp);
      }
    } catch (error) {
      console.error('Error fetching historical events:', error);
    }
  }

  // Setup event listeners with FundsSecured filtering
  function setupEventListeners() {
    if (!contract) return;
    contract.events.allEvents({ fromBlock: 'latest' }, async (error, event) => {
      if (error) {
        console.error('Error on event', error);
        return;
      }
      const isOwner = userAddress && userAddress.toLowerCase() === ownerAddress?.toLowerCase();
      const txHash = event.transactionHash;
      const details = formatEventDetails(event);
      const isAdminEvent = [
        'PaymentTokenAdded', 'PaymentTokenRemoved', 'RateSet', 'RateRemoved',
        'RewardSet', 'RewardRemoved', 'MinBuyToRewardSet', 'MinBuyToRewardRemoved',
        'Withdrawn', 'Paused', 'Unpaused'
      ].includes(event.event);
      // Skip FundsSecured for non-owners
      if (event.event === 'FundsSecured' && !isOwner) return;
      if (!isOwner && isAdminEvent) return;
      logEvent(event.event, details, true, isAdminEvent, txHash);
    });
  }

  // Updated connectWallet with unified chain ID
  async function connectWallet() {
    console.log("Connecting wallet...");
    if (!window.ethereum) {
      showError('home', "Please install MetaMask!");
      showWalletInstructions();
      return;
    }
    try {
      const accounts = await window.ethereum.request({ 
        method: 'eth_requestAccounts',
        timeout: 10000 
      }).catch(async (err) => {
        if (err.code === -32002) {
          throw new Error("Request already pending in MetaMask. Please check your wallet.");
        }
        throw err;
      });
      if (!accounts || accounts.length === 0) {
        throw new Error("No accounts returned from MetaMask.");
      }
      web3 = new Web3(window.ethereum);
      userAddress = accounts[0];
      const chainId = await web3.eth.getChainId();
      if (chainId !== AMOY_CHAIN_ID) {
        console.log("Switching to Polygon Amoy...");
        await switchToAmoy();
        return;
      }
      await initializeAfterConnect();
      logEvent('Wallet Connected', `Connected to ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`);
    } catch (error) {
      console.error("Wallet connection error:", error);
      if (error.code === 4001) {
        showError('home', "Connection rejected by user.");
      } else if (error.code === -32002) {
        showError('home', error.message);
      } else {
        showError('home', "Failed to connect wallet: " + (error.message || "Unknown error"));
      }
    }
  }

  // Updated initializeAfterConnect with unified chain ID
  async function initializeAfterConnect() {
    if (!web3 || !userAddress) return;
    try {
      const chainId = await web3.eth.getChainId();
      const networkName = chainId === AMOY_CHAIN_ID ? 'Polygon Amoy' : 'Unknown Network';
      if (chainId !== AMOY_CHAIN_ID) {
        showError('home', "Please switch to Polygon Amoy (Chain ID: 80002)");
        await switchToAmoy();
        return;
      }
      contract = new web3.eth.Contract(GrandSaleABI, CONTRACT_ADDRESS);
      ownerAddress = await contract.methods.owner().call();
      // ... (rest of the function remains unchanged) ...
    } catch (error) {
      console.error("Initialization after connect failed:", error);
      showError('home', "Failed to initialize dApp: " + error.message);
      disconnectWallet();
    }
  }

  // ... (rest of the JavaScript remains unchanged) ...

  window.addEventListener('load', initializeWeb3);
 </script>
</body>
</html>
