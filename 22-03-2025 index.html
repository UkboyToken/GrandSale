<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Sale (Polygon Amoy)</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            width: 90%;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        header h1 {
            margin: 0;
            font-size: 2em;
            color: #1a73e8;
        }
        nav {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        nav button {
            padding: 12px 24px;
            border: none;
            background-color: #34c759;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s, transform 0.2s;
            min-width: 120px;
        }
        nav button:hover {
            background-color: #2ba844;
            transform: scale(1.05);
        }
        .section {
            display: none;
            padding: 20px;
        }
        .section.active {
            display: block;
        }
        .wallet-status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }
        .wallet-status button, .control-btn {
            padding: 10px 20px;
            border: none;
            background-color: #1a73e8;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            min-width: 140px;
        }
        .wallet-status button:hover, .control-btn:hover {
            background-color: #1557b0;
        }
        .wallet-connected {
            color: #34c759;
            font-weight: bold;
            margin: 10px 0;
        }
        .wallet-instructions {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff3cd;
            color: #856404;
            border-radius: 6px;
            border: 1px solid #ffeeba;
            width: 100%;
        }
        .logs {
            margin-top: 20px;
            display: none;
        }
        .logs h3 {
            background-color: #1a73e8;
            color: #fff;
            padding: 10px;
            margin: 0;
            border-radius: 6px 6px 0 0;
            text-align: center;
        }
        .log-content {
            padding: 10px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 0 0 6px 6px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .log-table th, .log-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
            word-wrap: break-word;
        }
        .log-table th:nth-child(1), .log-table td:nth-child(1) { width: 20%; }
        .log-table th:nth-child(2), .log-table td:nth-child(2) { width: 20%; }
        .log-table th:nth-child(3), .log-table td:nth-child(3) { width: 60%; }
        .event-success { color: #28a745; }
        .event-error { color: #dc3545; }
        .contract-info-table, .payment-tokens-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .contract-info-table th, .contract-info-table td,
        .payment-tokens-table th, .payment-tokens-table td {
            padding: 12px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }
        .contract-info-table th {
            background-color: #1a73e8;
            color: #fff;
        }
        .payment-tokens-table th {
            background-color: #34c759;
            color: #fff;
        }
        .contract-info-table td, .payment-tokens-table td {
            position: relative;
        }
        .copy-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 4px 8px;
            background-color: #34c759;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .payment-tokens-table th:nth-child(1), .payment-tokens-table td:nth-child(1) { width: 40%; }
        .payment-tokens-table th:nth-child(2), .payment-tokens-table td:nth-child(2) { width: 20%; }
        .payment-tokens-table th:nth-child(3), .payment-tokens-table td:nth-child(3) { width: 15%; }
        .payment-tokens-table th:nth-child(4), .payment-tokens-table td:nth-child(4) { width: 25%; }
        .error {
            color: #dc3545;
            margin-top: 10px;
            word-wrap: break-word;
        }
        #token-receive-info {
            margin-top: 10px;
            font-weight: bold;
            color: #1a73e8;
        }
        select, input[type="text"], input[type="number"] {
            width: 100%;
            max-width: 280px;
            height: 40px;
            padding: 8px;
            margin: 8px 0;
            border: 1px solid #1a73e8;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
        }
        .input-group {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .max-btn {
            padding: 6px 12px;
            background-color: #34c759;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .balance-display {
            margin: 8px 0;
            font-size: 0.9em;
            color: #1a73e8;
            cursor: pointer;
        }
        .balance-display:hover {
            text-decoration: underline;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        @media (max-width: 600px) {
            nav { flex-direction: column; }
            nav button { width: 100%; max-width: 200px; margin: 5px auto; }
            .wallet-status { flex-direction: column; }
            .wallet-status button, .control-btn { width: 100%; max-width: 200px; }
            .control-row { flex-direction: column; align-items: stretch; }
            select, input[type="text"], input[type="number"] { max-width: 100%; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Grand Sale (Polygon Amoy)</h1>
            <div class="wallet-status" id="wallet-status">
                <button id="connect-wallet-btn" class="control-btn">Connect Wallet</button>
                <button id="switch-account-btn" class="control-btn" style="display: none;">Change Wallet</button>
                <button id="add-amoy-btn" class="control-btn">Add Amoy Network</button>
                <button id="add-sale-token-btn" class="control-btn" style="display: none;">Add Sale Token</button>
                <button id="add-payment-token-btn" class="control-btn" style="display: none;">Add Payment Token</button>
                <select id="payment-token-to-metamask" style="display: none;">
                    <option value="">Select Payment Token</option>
                </select>
                <button id="refresh-btn" class="control-btn">Refresh</button>
                <div id="wallet-info" style="display: none; width: 100%;">
                    <p id="connected-address" class="wallet-connected"></p>
                    <p id="connected-network"></p>
                    <button id="disconnect-wallet-btn" class="control-btn">Disconnect</button>
                </div>
                <div id="wallet-instructions" class="wallet-instructions" style="display: none;"></div>
            </div>
        </header>
        <nav id="navigation">
            <button id="home-btn" onclick="showSection('home')" style="display: none;">Home</button>
            <button id="admin-btn" onclick="showSection('owner')" style="display: none;">Admin</button>
        </nav>
        <div id="home" class="section active">
            <h2>Grand Sale</h2>
            <table class="contract-info-table">
                <thead>
                    <tr>
                        <th>Detail</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Contract Address</td><td id="contract-address">Not Connected<button class="copy-btn" onclick="copyToClipboard('contract-address')">Copy</button></td></tr>
                    <tr><td>Sale Token</td><td id="sale-token">Not Connected<button class="copy-btn" onclick="copyToClipboard('sale-token')">Copy</button></td></tr>
                    <tr><td>Total Unsold</td><td id="total-unsold">Not Connected</td></tr>
                    <tr><td>Minimum Buy to Reward</td><td id="min-buy-to-reward">Not Connected</td></tr>
                    <tr><td>Total Sold</td><td id="total-sold">Not Connected</td></tr>
                    <tr><td>Total Rewarded</td><td id="total-rewarded">Not Connected</td></tr>
                </tbody>
            </table>
            <div>
                <h3>Accepted Payment Tokens</h3>
                <table class="payment-tokens-table" id="payment-tokens-table">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Rate</th>
                            <th>Reward (%)</th>
                            <th>Total Raised</th>
                        </tr>
                    </thead>
                    <tbody id="payment-tokens-body"></tbody>
                </table>
            </div>
            <div class="control-group">
                <h3>Your Balance</h3>
                <p>Sale Token Balance: <span id="user-sale-balance">0</span></p>
            </div>
            <div class="control-group">
                <h3>Increase Token Allowance</h3>
                <div class="control-row">
                    <select id="approve-token-select" onchange="updateApproveBalance()">
                        <option value="">Select Payment Token</option>
                    </select>
                    <span id="approve-balance" class="balance-display" onclick="setMaxApprove()">0</span>
                </div>
                <div class="control-row">
                    <div class="input-group">
                        <input type="number" id="approve-amount" placeholder="Amount to Approve" step="0.01">
                        <button class="max-btn" onclick="setMaxApprove()" style="display: none;">Max</button>
                    </div>
                    <button id="approve-btn" class="control-btn" onclick="approveToken()">Approve</button>
                </div>
            </div>
            <div class="control-group">
                <h3>Buy Tokens</h3>
                <div class="control-row">
                    <select id="payment-token-select" onchange="updateBuyBalance()">
                        <option value="">Select Payment Token</option>
                    </select>
                    <span id="buy-balance" class="balance-display" onclick="setMaxBuy()">0</span>
                </div>
                <div class="control-row">
                    <div class="input-group">
                        <input type="number" id="payment-amount" placeholder="Amount" step="0.01" oninput="updateTokenReceiveInfo()">
                        <button class="max-btn" onclick="setMaxBuy()" style="display: none;">Max</button>
                    </div>
                    <button id="buy-btn" class="control-btn" onclick="buyTokens()">Buy</button>
                </div>
                <p id="token-receive-info"></p>
            </div>
            <div class="control-group">
                <h3>Send Sale Tokens</h3>
                <div class="control-row">
                    <input type="text" id="send-recipient" placeholder="Recipient Address">
                    <span id="send-balance" class="balance-display" onclick="setMaxSend()">0</span>
                </div>
                <div class="control-row">
                    <div class="input-group">
                        <input type="number" id="send-amount" placeholder="Amount to Send" step="0.01">
                        <button class="max-btn" onclick="setMaxSend()">Max</button>
                    </div>
                    <button id="send-btn" class="control-btn" onclick="sendTokens()">Send Tokens</button>
                </div>
            </div>
            <div id="tx-status"></div>
            <div id="error-message" class="error"></div>
        </div>
        <div id="owner" class="section">
            <h2>Admin</h2>
            <div class="control-group">
                <h3>Manage Payment Tokens</h3>
                <div class="control-row">
                    <input type="text" id="payment-token-address" placeholder="Payment Token Address">
                    <button id="add-payment-btn" class="control-btn" onclick="addPaymentToken()">Add Payment Token</button>
                </div>
                <div class="control-row">
                    <select id="remove-payment-token-select">
                        <option value="">Select Payment Token to Remove</option>
                    </select>
                    <button id="remove-payment-btn" class="control-btn" onclick="removePaymentToken()">Remove Payment Token</button>
                </div>
            </div>
            <div class="control-group">
                <h3>Set Rate</h3>
                <div class="control-row">
                    <select id="rate-token">
                        <option value="">Select Payment Token</option>
                    </select>
                    <input type="number" id="rate-value" placeholder="Rate" step="1">
                </div>
                <div class="control-row">
                    <button id="set-rate-btn" class="control-btn" onclick="setRate()">Set Rate</button>
                    <button id="remove-rate-btn" class="control-btn" onclick="removeRate()">Remove Rate</button>
                </div>
            </div>
            <div class="control-group">
                <h3>Set Reward</h3>
                <div class="control-row">
                    <select id="reward-token">
                        <option value="">Select Payment Token</option>
                    </select>
                    <input type="number" id="reward-value" placeholder="Reward Percentage (1-100)" step="1">
                </div>
                <div class="control-row">
                    <button id="set-reward-btn" class="control-btn" onclick="setReward()">Set Reward</button>
                    <button id="remove-reward-btn" class="control-btn" onclick="removeReward()">Remove Reward</button>
                </div>
            </div>
            <div class="control-group">
                <h3>Set Minimum Buy to Reward</h3>
                <div class="control-row">
                    <input type="number" id="min-buy-value" placeholder="Minimum Buy Amount" step="1">
                    <button id="set-min-buy-btn" class="control-btn" onclick="setMinBuyToReward()">Set Min Buy</button>
                </div>
                <div class="control-row">
                    <button id="remove-min-buy-btn" class="control-btn" onclick="removeMinBuyToReward()">Remove Min Buy</button>
                </div>
            </div>
            <div class="control-group">
                <h3>Contract Status</h3>
                <p>Status: <span id="contract-status">Unknown</span></p>
                <button id="toggle-pause-btn" class="control-btn" onclick="togglePause()">Toggle Pause</button>
            </div>
            <div class="control-group">
                <h3>Withdraw</h3>
                <div class="control-row">
                    <select id="withdraw-token">
                        <option value="">Select Token to Withdraw</option>
                    </select>
                    <input type="number" id="withdraw-amount" placeholder="Amount" step="0.01">
                </div>
                <div class="control-row">
                    <button id="withdraw-btn" class="control-btn" onclick="withdraw()">Withdraw</button>
                </div>
            </div>
            <div id="tx-status"></div>
            <div id="error-message" class="error"></div>
        </div>
        <div id="logs" class="logs">
            <h3>Logs</h3>
            <div class="log-content">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Event</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="log-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/web3@1.10.4/dist/web3.min.js"></script>
    <script>
        // JavaScript remains unchanged as functionality is intact
        const CONTRACT_ADDRESS = "0x65ed5aa09d34959214bdbb8b634e486081447e36";
        const GrandSaleABI = [/* ABI unchanged */];
        const ERC20ABI = [/* ABI unchanged */];

        let web3, contract, userAddress, saleTokenAddress, ownerAddress, saleTokenSymbol = "Token";
        let tokenInfoMap = new Map();
        const NATIVE_TOKEN_ADDRESS = "0x0000000000000000000000000000000000000000";

        // Helper Functions (unchanged)
        async function getTokenInfo(tokenAddress) {/* unchanged */}
        async function fetchAcceptedPaymentTokens() {/* unchanged */}
        async function updatePaymentTokensTable() {/* unchanged */}
        async function getTransactionTimestamp(txHash) {/* unchanged */}
        function logEvent(eventName, details, isSuccess = true, isAdminEvent = false, txHash = null) {/* unchanged */}
        function showError(section, message, txHash = null) {/* unchanged */}
        function showTxStatus(section, message) {/* unchanged */}

        // Event Listeners for Buttons (unchanged)
        document.getElementById('connect-wallet-btn').addEventListener('click', connectWallet);
        document.getElementById('switch-account-btn').addEventListener('click', switchAccount);
        document.getElementById('disconnect-wallet-btn').addEventListener('click', disconnectWallet);
        document.getElementById('add-amoy-btn').addEventListener('click', addAmoyNetwork);
        document.getElementById('add-sale-token-btn').addEventListener('click', addSaleTokenToMetaMask);
        document.getElementById('add-payment-token-btn').addEventListener('click', () => {
            const dropdown = document.getElementById('payment-token-to-metamask');
            dropdown.style.display = dropdown.style.display === 'none' ? 'inline-block' : 'none';
        });
        document.getElementById('payment-token-to-metamask').addEventListener('change', addPaymentTokenToMetaMask);
        document.getElementById('refresh-btn').addEventListener('click', refreshPage);

        // Wallet Connection Functions (unchanged)
        async function connectWallet() {/* unchanged */}
        async function switchAccount() {/* unchanged */}
        async function disconnectWallet() {/* unchanged */}
        async function addAmoyNetwork() {/* unchanged */}
        async function addSaleTokenToMetaMask() {/* unchanged */}
        async function addPaymentTokenToMetaMask() {/* unchanged */}
        async function refreshPage() {/* unchanged */}
        async function initializeAfterConnect() {/* unchanged */}
        async function switchToAmoy() {/* unchanged */}
        function showWalletInstructions() {/* unchanged */}
        function copyToClipboard(elementId) {/* unchanged */}

        // UI Functions (unchanged)
        function showSection(sectionId) {/* unchanged */}
        async function updateContractInfo() {/* unchanged */}
        async function updateUserBalance() {/* unchanged */}
        async function updateApproveBalance() {/* unchanged */}
        async function updateBuyBalance() {/* unchanged */}
        async function estimateGasForBuyWithNative() {/* unchanged */}
        async function setMaxBuy() {/* unchanged */}
        function setMaxApprove() {/* unchanged */}
        function setMaxSend() {/* unchanged */}
        async function updatePaymentTokenDropdowns() {/* unchanged */}
        async function updateWithdrawDropdown() {/* unchanged */}
        async function updateAllDropdowns() {/* unchanged */}

        // Admin Functions (unchanged)
        async function addPaymentToken() {/* unchanged */}
        async function removePaymentToken() {/* unchanged */}
        async function setRate() {/* unchanged */}
        async function removeRate() {/* unchanged */}
        async function setReward() {/* unchanged */}
        async function removeReward() {/* unchanged */}
        async function setMinBuyToReward() {/* unchanged */}
        async function removeMinBuyToReward() {/* unchanged */}
        async function togglePause() {/* unchanged */}
        async function withdraw() {/* unchanged */}

        // User Functions (unchanged)
        async function approveToken() {/* unchanged */}
        async function buyTokens() {/* unchanged */}
        async function sendTokens() {/* unchanged */}
        async function updateTokenReceiveInfo() {/* unchanged */}

        // Event Listeners Setup (unchanged)
        function setupEventListeners() {/* unchanged */}
        function formatEventDetails(event) {/* unchanged */}

        // Initialization (unchanged)
        logEvent('Page Loaded', 'DApp initialized');
    </script>
</body>
</html>
